# 作用  
对比片段深度值与深度缓冲，通过则更新，否则丢弃。实现视线物体顺序遮挡。  
  
# 位置  
fs和模板测试后，屏幕空间  
大部分gpu支持提前深度测试，减少fs计算量，前提fs不改变深度值  
  
# 原理  
深度值：观察空间坐标z分量计算，得到屏幕空间z分量，即深度值  
  
$$F_{depth}=\frac{\frac{1}{z}-\frac{1}{near}}{\frac{1}{far}-\frac{1}{near}}$$    
这里的far和near是投影平截头体里面的  
z\[1,2]变换到\[0.5,1]，非线性深度值使精度与距离负相关更真实，给近物体更大深度精度  
![z-depth-value](z-depth-value.png)  
  
由深度值变成NDC，\[0, 1\]范围变换到\[-1, 1\]范围：  
```c++  
float ndc = depth * 2.0 - 1.0;  
```  
# 使用  
  
启用深度测试  
```c++  
glEnable(GL_DEPTH_TEST);  
```  
渲染循环清除上轮深度缓冲  
```c++  
glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);  
```  
设置只读深度缓冲  
```c++  
glDepthMask(GL_FALSE);  
```  
设置比较符  
```c++  
glDepthFunc(GL_LESS);//默认，即深度值小于当前深度缓冲值时更新  
```  
  
| GL_ALWAYS   | 永远通过  |  
| ----------- | ----- |  
| GL_NEVER    | 永远不通过 |  
| GL_LESS     | 小于通过  |  
| GL_EQUAL    | 等于    |  
| GL_NOTEQUAL | 不等于   |  
| GL_LEQUAL   | 小于等于  |  
| GL_GREATER  | 大于    |  
| GL_GEQUAL   | 大于等于  |  
可以通过gl_FragCoord向量获取深度值：`gl_FragCoord.z`  
  
# 深度冲突  
距离过近，精度不足，会在二者来回切换  
1. 增加物体间距离  
2. 将近平面设置远一些，即near设置大一些。物体精度在接近近平面会较高  
3. 增加深度缓冲位数从而提高精度  