用仿射摄像机重述两视图几何  
  
## 仿射对极几何  
光心为无穷远点，所以所有像点的反向投影射线平行  
三维元素经两个仿射摄像机映射出来的两个像之间相差一个仿射变换，而仿射变换保持平行  
因此反向投影线在另一幅图的像，即对极线，相互平行  
对极平面同理  
基线显然在无穷远平面，因此对极点也是无穷远点  
  
  
## 仿射基本矩阵  
#### 形式  
两个仿射摄像机的基本矩阵形式为  
$$\begin{gathered}F_A= \begin{bmatrix}0 & 0 & a \\0 & 0 & b \\ c & d & e\end{bmatrix}\end{gathered}$$  
abcde为非零元素  
一般情况下秩为2  
#### 几何推导  
投影线平行，场景平面到像平面都是仿射变换  
因此像平面之间也是仿射变换  
即有$x' = H_A x$  
$l'$由连线可得，$l' = e' \times H_A x$  
由定义，$F$是$x$到$l'$的映射，因此  
  
$$F_A = [e'] \times H_A =   
\begin{bmatrix}  
0 & 0 & * \\  
0 & 0 & * \\  
* & * & 0 \\  
\end{bmatrix}   
\begin{bmatrix}  
* & * & * \\  
* & * & * \\  
0 & 0 & 1 \\  
\end{bmatrix}=  
\begin{bmatrix}  
0 & 0 & * \\  
0 & 0 & * \\  
* & * & * \\  
\end{bmatrix}$$  
  
\*为非零元素  
#### 性质  
秩为2，4dof  
**对应点**  
对于对应点$x = (x, y, 1)^T$ 和 $x' = (x', y', 1)^T$，有$x'^T F_A x = 0$；对应点为有限点时有$ax' + by' + cx + dy + e = 0$  
**对极线**  
$l' = F_A x = (a, b, cx + dy + e)^T$ 是对应于 $x$ 的对极线  
$l = F_A^T x' = (c, d, ax + by + e)^T$ 是对应于 $x'$ 的对极线  
**对极点**  
由 $F_A e = 0$ 得 $e = (-d, c, 0)^T$  
由 $F_A^T e' = 0$ 得 $e' = (-b, a, 0)^T$  
**由一般摄像机计算**  
$F_A = [e']_A P_A' P_A^+$，其中 $P_A^+$ 是 $P_A$ 的伪逆，而 $e'$ 是由 $e' = P_A' C$ 所确定的对极点， $C$ 是$P_A$光心  
**由规范摄像机计算**  
  
$$P_A = \begin{bmatrix}  
    1 & 0 & 0 & 0 \\  
    0 & 1 & 0 & 0 \\  
    0 & 0 & 0 & 1   
    \end{bmatrix} \quad P_A' = \left[  
\begin{array}{ccc|c}  
 & M_{2\times3}& & t\\  
0&0&0 & 1  
\end{array}  
\right]$$  
  
$a = m_{23}, \quad b = -m_{13}, \quad c = m_{13} m_{21} - m_{11} m_{23}$  
$d = m_{13} m_{22} - m_{12} m_{23}, \quad e = m_{13} t_2 - m_{23} t_1$  
  
## 由对应点估计基本矩阵  
有匹配点对 $x \leftrightarrow x'$，$x_i = (x_i, y_i, 1)^T$ 和 $x_i' = (x_i', y_i', 1)^T$，则关于 $F_A$有方程  
  
$$ax_i' + by_i' + cx_i + dy_i + e = 0$$  
  
#### 线性算法  
  
上式即  $$(x_i', y_i', x_i, y_i, 1) f = 0$$  
其中$f = (a, b, c, d, e)^T$  
对于n组匹配，有方程组$Af=0$，展开为  
  
$$\begin{bmatrix} x_1' & y_1' & x_1 & y_1 & 1 \\ \vdots & \vdots & \vdots & \vdots & \vdots \\ x_n' & y_n' & x_n & y_n & 1 \end{bmatrix} f = 0$$  
  
因而f最小配置解需要一般位置的4组对应  
若超定且有噪声则可以参考DLT的超定约束，即求A的最小奇异值的奇异变量，等价于8点算法但不推荐  
  
奇异性约束：$F_A$的形式上保证了秩小于等于2，不需要另外约束  
  
#### 黄金标准算法  
（仿射相关证明推导暂略（？））  
有n组对应的对应集$\{x_i \leftrightarrow x'_i\}$，假设噪声符合各向同性齐次高斯分布，则$F_A$的MLE需要最小化几何误差  
$$\min_{\{F_A, \hat{x}_i, \hat{x}'_i\}} \sum_{i} d(x_i, \hat{x}_i)^2 + d(x', \hat{x}'_i)^2 $$  
归一化算法总结如下：  
记对应点为$X_i = (x_i', y_i', x_i, y_i)^T$  
计算形心 $\overline{X} = \frac{1}{n} \sum_i X_i$，并中心化各向量 $\Delta X_i = X_i - \overline{X}$  
计算行向量为 $\Delta X_i^T$ 的 $n \times 4$ 的矩阵 $A$  
$N = (a, b, c, d)^T$ 是 $A$ 的对应最小奇异值的奇异向量，而 $e = -N^T \overline{X}$  
由abcde可得  
  
$$\begin{gathered}F_A= \begin{bmatrix}0 & 0 & a \\0 & 0 & b \\ c & d & e\end{bmatrix}\end{gathered}$$  
  
  
#### 最小配置  
给定 4 组图像点对应 $x_i \leftrightarrow x_j'$，$i = 1, \cdots, 4$，计算仿射基本矩阵  
  
前 3 个 3D 点 $X_i$, $i = 1, \cdots, 3$ 定义一张平面 $\pi$  
已知像平面之间相差一个二维仿射变换，则$x_i' = H_A x_i$, $i = 1, \cdots, 3$可得仿射变换矩阵 $H_A$  
根据 $l' = (H_A x_4) \times x_4'$ 确定对极线，由此得到对极点 $e' = (-l_2', l_1', 0)^T$  
任意点 $x$ 在第二幅视图中的对极线是 $e' \times (H_A x) = F_A x$。因此 $F_A = [(-l_2', l_1', 0)^T]_\times H_A$  
  
退化：  
四点共面（没有视差）  
三点共线（计算不出$H_A$）  
摄像机光心重合，即同一无穷远点，即摄像方向平行  
以上几种退化情况计算不出$F_A$  
都不满足则为一般位置  
  
## 三角测量  
有一组测量对应 $(x,y)^T \leftrightarrow (x',y')^T$ 和仿射基本矩阵 $F_A$  
满足高斯噪声假设  
确定真实对应 $(\hat{x},\hat{y})^T \leftrightarrow (\hat{x}',\hat{y}')^T$ 的MLE，然后可以由MLE的对应来确定 3D 点。  
  
参考12章，MLE 满足 $(\hat{x}',\hat{y}',1)F_A(\hat{x},\hat{y},1)^T = 0$，并且也最小化到测量点的图像距离  
$$(x - \hat{x})^2 + (y - \hat{y})^2 + (x' - \hat{x}')^2 + (y' - \hat{y}')^2$$  
**几何解释**  
在由 $F_A$ 定义的超平面上求与测量对应 $X = (x',y',x,y)^T$ 最接近的点  
同样，此时 Sampson 矫正式是精确的  
  
**代数解释**  
超平面的法线方向是 $N = (a,b,c,d)^T$，并且点 $X$ 到该超平面的垂直距离由 $d_\perp = (N^T X + e)/\|N\|$ 给出，因此$\hat{X} = X - d_\perp \frac{N}{\|N\|}$，展开即  
  
$$\begin{pmatrix} \hat{x}' \\ \hat{y}' \\ \hat{x} \\ \hat{y} \end{pmatrix} = \begin{pmatrix} x' \\ y' \\ x \\ y \end{pmatrix} - \frac{(ax' + by' + cx + dy + e)}{(a^2 + b^2 + c^2 + d^2)} \begin{pmatrix} a \\ b \\ c \\ d \end{pmatrix}$$  
  
  
  
  
## 仿射重构  
有4组图像对应点，且假设测量无误差时，可以对三维点和摄像机重构  
仿射情况下，得到的是仿射重构  
  
对此的简单证明：  
一般位置的4个三维点，以一个$X_0$为原点，结合另外三个确定三个基向量$\mathbf{E}_i = \bar{X}_i - \bar{X}_0$，$i = 1, \cdots, 3$，建立非齐次世界坐标系  
任意三维点P可以在这个坐标系中得到一个三维向量非齐次坐标$\tilde{P} = \tilde{X}_0 + X\mathbf{E}_1 + Y\mathbf{E}_2 + Z\mathbf{E}_3$即$(X,Y,Z)^T$  
上述各元素（原点、基向量、三维点）各经仿射摄像机投影后，在像平面上的三维向量非齐次坐标$(X,Y,Z)^T$不变，由此可以列出$\tilde{p} - \tilde{x}_0 = X \vec{e}_1 + Y \vec{e}_2 + Z \vec{e}_3$  
这个方程中的其他量都是可以计算出来的  
每幅图都能提供这样的一个方程约束，两视图提供2个约束，正好解出$(X,Y,Z)^T$  
  
  
## Necker反转多义性和浅浮雕多义性  
已标定情况下可以把仿射重构确定到有限种多义性  
#### 有限反射多义性/Necker反转多义性  
平行投影下旋转与其镜像反转图像相同  
#### 单参数族旋转多义性/浅浮雕多义性  
仿射条件下只能确定旋转角与深度的乘积，但不能精确区分旋转角与深度  
  
## 运动重构  
两个弱透视摄像机情况下，由 $F_A$ 计算摄像机运动  
摄像机矩阵取为$$P = \begin{bmatrix} \alpha_x & 1 & 0 & 0 & 0 \\ \alpha_y & 0 & 1 & 0 & 0 \\ 1 & 0 & 0 & 0 & 1 \end{bmatrix}, \quad P' = \begin{bmatrix} \alpha'_x & 1 \\ \alpha'_y & 1 \end{bmatrix} \begin{bmatrix} r^{1T} & t_1 \\ r^{2T} & t_2 \\ 0^T & 1 \end{bmatrix}$$  
$r^{1T}$ 和 $r^{2T}$ 是视图之间的旋转矩阵 $R$ 的第一行和第二行  
假设两个摄像机的宽高比 $\alpha_y / \alpha_x$ 都已知，但相对尺度 $s = \alpha'_x / \alpha_x$ 未知  
则摄像机远离物体时s<1，反之s>1  
  
由于浅浮雕多义性，R不能精确计算，但可以直接得到其他参数  
  
分解R，有$R = R_\rho R_\theta$  
在图像平面上有一个角度为$\theta$的轮式旋转 $R_\theta$（即绕视线旋转）  
另一个是绕轴$\Phi$，角度为$\rho$的旋转 $R_\rho$，$\Phi$的方向平行于图像平面并且与正X轴的夹角为 $\phi$，即一个转出图像平面的纯旋转  
![旋转分解|600](旋转分解.png)  
解$s$、$\phi$和$\theta$：  
$$\tan \phi = \frac{b}{a}, \quad \tan (\phi - \theta) = \frac{d}{c} \quad \text{和} \quad s^2 = \frac{c^2 + d^2}{a^2 + b^2}$$  
式中，$s > 0$（根据定义）  
注意 $\phi$ 是转出平面的旋转轴在 $I_2$ 中的投影角，而 $(\phi - \theta)$ 是它在 $I_1$ 中的投影角  