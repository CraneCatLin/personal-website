## 概述  
已知三维点X两图像上的像，已知一对摄像机矩阵，即已知基本矩阵，在像坐标测量有误差情况下，估计X的一个最优解  
像点测量有误差，即像点不满足$x'^T Fx = 0$，即反向投影射线不相交  
为保持三角测量法的仿射/射影不变性  
  
用 $\tau$ 表示由点对应 $x \leftrightarrow x'$ 及一对摄像机矩阵 $P$ 和 $P'$ 来计算 3D 空间点 $X$ 的一种三角测量法（函数），则$X = \tau (x, x', P, P')$  
若$\tau (x, x', P, P') = H^{-1} \tau (x, x', PH^{-1}, P'H^{-1})$，则称该三角测量是在变换H下不变的  
  
三维射影空间中距离、垂直等概念无意义，所以不能由误差最小化，即此方法不满足射影不变  
  
## 线性三角测量法  
方法参考第4章DLT  
#### 方程  
在两幅图中分别测量$x=PX$和$x'=P'X$，分别写成$x \times (PX) = 0$和$x' \times (P'X) = 0$  
  
$$  
x_i' \times P x_i =   
\begin{pmatrix}  
x(P^{3T}X) - (P^{1T}X) \\  
y(P^{3T}X) - (P^{2T}X) \\  
x(P^{2T}X) - y(P^{1T}X)  
\end{pmatrix}=0  
\to \begin{bmatrix} xP^{3T} - P^{1T} \\ yP^{3T} - P^{2T} \end{bmatrix}X=A_1X=0  
$$  
其中与DLT类似，考虑三个方程线性相关而只保留一个  
同理加上$x' \times (P'X) = 0$提供的两个方程，则一组对应点提供四个方程  
  
$$\begin{bmatrix} xP^{3T} - P^{1T} \\ yP^{3T} - P^{2T} \\ x'P^{3T} - P^{1T} \\ y'P^{3T} - P^{2T} \end{bmatrix}X=0$$  
注：  
$x_i'=PX_i$实际上应为$\lambda x_i'=PX_i$，而叉乘后$\lambda x_i' \times PX_i=0$可以消去这个不确定的尺度因子$\lambda$  
  
#### 齐次解法  
取A的最小奇异值对应的单位奇异向量作为解  
不具有仿射不变性  
#### 非齐次解法  
需要假设X不在无穷远点  
参考第4章对于非齐次的内容（待补充）；评价为可能不稳定，一般不提倡；暂略过  
具有仿射不变性  
  
  
## 几何误差  
取重投影误差$C(x,x') =d(x, \hat{x})^2 + d(x', \hat{x}')^2$，此处满足$\hat{x'}^T F\hat{x} = 0$  
即求最小化该误差的$\hat{x'}^T$和$\hat{x}$  
由此使用Levenberg-Marquardt 算法最小化误差  
  
## Sampson近似  
#### 几何误差的一阶近似  
推导及结果参考11章的Sampson即可，基本相同  
  
#### 矫正测量点的一阶近似  
一组测量点写成$X = (x, y, x', y')^T$的形式  
参考11章的Sampson近似，  
  
$$\delta_x = -J^T(JJ^T)^{-1} \epsilon$$  
  
$$J = \partial e / \partial x = [(F^T x')_1, (F^T x')_2, (Fx)_1, (Fx)_2]$$  
  
$$JJ^T = (Fx_i)_1^2 + (Fx_i)_2^2 + (F^T x_i')_1^2 + (F^T x_i')_2^2$$  
  
$$\epsilon={x'}_i^T F x_i$$  
则矫正后的点是$\hat{X} = X + \delta_x$，即  
  
$$\begin{pmatrix} \hat{x} \\ \hat{y} \\ \hat{x}' \\ \hat{y}' \end{pmatrix} = \begin{pmatrix} x \\ y \\ x' \\ y' \end{pmatrix} - \frac{x'^T Fx}{(Fx)_1^2 + (Fx)_2^2 + (F^T x')_1^2 + (F^T x')_2^2} \begin{pmatrix} (F^T x')_1 \\ (F^T x')_2 \\ (Fx)_1 \\ (Fx)_2 \end{pmatrix}$$  
矫正后的点不会精确符合对极关系  
矫正量极小（1像素）时该近似是准确的且计算量小  
  
## 最优解  
非迭代法求重投影误差代价函数全局最小值的三角测量法  
若高斯噪声假设成立则方法最优  
  
#### 对极线性质  
（此处先补充证明一个性质，下面重新格式化有用）  
  
在两幅图像中，若有一对对应的对极线，记为$l=F^Tx'$和$l'=Fx$  
已知对极线为像点和对极点连线，则$l$上任取一点可以表示为$p=x+\lambda e$  
$Fp=F(x+\lambda e)=Fx+\lambda Fe=Fx=l'$  
因此$l$上任取一点p都有$Fp=l'$  
又因$l'$上任取一点$p'$都有$p'^Tl'=0$  
则代入得到$p'^T Fp=0$  
综上，一对对极线上各任取一点得到的一对点均满足对极关系  
#### 最小化问题的重新公式化  
给定一对$x \leftrightarrow x'$测量点，求最小化重投影误差且满足对极几何约束的一对点$\hat{x} \leftrightarrow \hat{x}'$  
若给定一组对极线$l$与$l'$，在这组对极线上的满足对极几何约束的点对中，$x_\perp \leftrightarrow x'_\perp$最小化重投影误差，记为$\hat{x} \leftrightarrow \hat{x}'$  
此时距离$d(x, \hat{x})$可写为$d(x, l)$  
  
因此最小化重投影误差等价于最小化$d(x,l)^2 + d(x',l')^2$  
最小化步骤：  
- 已知对极点，此时由对极点和一个角度相关参数t可以确定一条对极线，又已知F，可确定另一条对极线，从而用单参数t参数化对极线束$l(t)$和$l'(t)$   
- 距离函数$d(x,l(t))^2 + d(x',l'(t))^2$显式地表示为t的函数$s(t)$  
- 求最小化$s(t)$的t  
  
$$\min_{\hat{x}} \mathcal{C} = d(x,\hat{x})^2 + d(x',\hat{x}')^2 = \min_{t} \mathcal{C} = d(x,l(t))^2 + d(x',l'(t))^2$$  
  
此时是t的有理多项式函数，可以简化为求6次多项式实根的问题  
  
  
#### 最小化的具体处理  
以下坐标不说明则均为齐次坐标  
为避免三维空间位置的不确定性，假设像点都不在对极点  
为简化处理，先分别在两个像面上作欧式变换，使得$x=x'=(0,0,1)^T$且$e=(1,0,f)^T$，$e'=(1,0,f')^T$  
由于$Fe= e'^T F = 0$，可得F的一个参数形式为  
  
$$F = \begin{pmatrix} f'f d & -f' c & -f' d \\ -f b & a & b \\ -f d & c & d \end{pmatrix}$$  
下求$l(t)$：  
设l通过点 $p=(0,t,1)^T$和对极点$e=(1,0,f)^T$，则$l^T=(0,t,1)^T \times (1,0,f)^T = (tf,1,-t)^T$  
由点到直线距离公式，x到l距离有$$d(x,I(t))^2 = \frac{t^2}{1+(tf)^2}$$  
  
$$I'(t) =Fp= F(0,t,1)^T = (-f'(ct+d), at+b, ct+d)^T$$  
  
$$\Rightarrow d(x',I'(t))^2 = \frac{(ct+d)^2}{(at+b)^2 + f'^2(ct+d)^2}$$  
  
$$\Rightarrow s(t) = d(x,l(t))^2 + d(x',l'(t))^2=\frac{t^2}{1+f^2t^2} + \frac{(ct+d)^2}{(at+b)^2 + f'^2(ct+d)^2}$$  
之后求此函数最小值，即求各极值，即求一阶导的根，  
$s(t)$一阶导为  
  
$$s'(t) = \frac{2t}{(1 + f^2 t^2)^2} - \frac{2 (ad - bc)(at + b)(ct + d)}{((at + b)^2 + f'^2 (ct + d)^2)^2}$$  
一阶导通分后分子为  
  
$$g(t) = t ((at + b)^2 + f'^2 (ct + d)^2)^2 - (ad - bc)(1 + f^2 t^2)^2 (at + b)(ct + d)$$  
此即上文所说六次多项式，即求此多项式根，最多6个实根（3极大和3极小）  
  
#### 最小化问题总结  
已知一组测量得到的点对应 $x \leftrightarrow x'$和基本矩阵$F_0$，计算在对极几何约束$\hat{x}'^T F_0 \hat{x} = 0$下最小化重投影误差的矫正对应$\hat{x} \leftrightarrow \hat{x}'$  
$x = (x, y, 1)^T$，$x' = (x', y', 1)^T$  
  
**平移像点**  
构造如下欧式变换矩阵  
  
$$T = \begin{bmatrix} 1 & 0 & -x \\ 0 & 1 & -y \\ 0 & 0 & 1 \end{bmatrix} \quad \text{和} \quad T' = \begin{bmatrix} 1 & 0 & -x' \\ 0 & 1 & -y' \\ 0 & 0 & 1 \end{bmatrix}$$  
满足$Tx=T'x'=(0,0,1)^T$  
此时$F_1=T'^{-T} F_0 T^{-1}$  
  
**求归一化对极点**  
计算满足$e'^T F_1 = 0$和$F_1 e = 0$的对极点 $e = (e_1, e_2, e_3)^T$ 和 $e' = (e_1', e_2', e_3')^T$。归一化 $e$（乘一个标量）使得 $e_1^2 + e_2^2 = 1$，$e'$同理处理  
  
**移动对极点**  
构造如下旋转矩阵  
  
$$R = \begin{bmatrix} e_1 & e_2 & 0 \\ -e_2 & e_1 & 0 \\ 0 & 0 & 1 \end{bmatrix} \quad \text{和} \quad R' = \begin{bmatrix} e_1' & e_2' & 0 \\ -e_2' & e_1' & 0 \\ 0 & 0 & 1 \end{bmatrix}$$  
满足 $R e = (1, 0, e_3)^T$ 和 $R' e' = (1, 0, e_3')^T$  
此时$F_2=R' F_1 R^{-1}$  
令 $f = e_3, f' = e_3', a = F_{22}, b = F_{23}, c = F_{32}, d = F_{33}$，则$F_2$应当与上文F的参数形式等价  
  
**求出重投影误差的t参数形式并最小化**  
参考上一节，依次求出$d(x,I(t))^2$、$d(x',I'(t))^2$、$s(t)$、$s'(t)$、$g(t)$  
由此解$g(t)$根得到极值点，回代$s(t)$得到最小值  
  
  
#### 局部最小  
由于最多可能有三个极小值，任意初始值开始迭代搜索可能陷入局部最优。  
此处即使局部最优也可能满足对极匹配  
  
## 估计3D点的概率分布  
沿着像点反向投影射线方向有圆锥形空间，三维点概率分布在此空间内  
从估计三维点分布来研究重构的精度  
（实话说没搞懂这块讲的什么意义，待补充？ #todo ）  
  
## 直线重构  
直线重构基本思想：像直线反向投影平面相交  
点重构是超定的，即三维点有3dof，测量两个像点各2dof  
直线重构是准确确定的，即三维线有4dof，测量两条像直线各2dof  
  
对像直线$l$和$l'$，反向投影为$\pi = P^T l$和$\pi' = P'^T l'$，由此记三维直线为  
  
$$L = \begin{bmatrix} l^T P \\ l'^T P' \end{bmatrix}$$  
满足：若$L X = 0$，则点$X$在该直线上  
#### 退化  
若三维线L与基线相交，交点记为X，X在基线上  
已知$\pi$和$\pi'$会过两个光心，现在又都过X，则两平面都过基线  
此时两平面都过一对相交直线，可知二者重合，因而无法确定原直线L，即退化  
  
考虑测量有误差，L与基线近似相交时也会有类似问题导致退化  
  
#### 多视图重构  
暂略 #todo   