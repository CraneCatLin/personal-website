## 针孔模型  
- 三维世界坐标系  
- 像平面$Z = f$，其xy轴方向同世界坐标系  
- 摄像机坐标系，其原点即光心初始同世界坐标系原点，其Z轴方向初始同世界坐标系  
  
光心/摄像机中心初始在世界坐标系原点（非齐次变齐次时默认齐次w=1）  
主轴/主射线：光心到像平面垂线，初始为Z轴方向  
  
主点：主轴与像平面交点  
主平面：过光心的像平面的平行平面  
  
三维空间点形如$\mathbf{X} = (X, Y, Z)^T$，二维平面点形如$x=(x, y)^T$  
$X_{cam}$ 为点在摄像机坐标系，$X$为点在世界坐标系，$x$为点在像平面坐标系  
加波浪号如$\tilde{\mathbf{X}}$表示非齐次坐标  
  
- 无偏移时（仅直接投影）（+1dof）  
	此时摄像机坐标系同世界坐标系  
	$(X, Y, Z)^T$ 映射像平面上的点 $(fX/Z, fY/Z, f)^T$即$(fX/Z, fY/Z)^T$  
	  
	$$  
	\begin{pmatrix} fX \\ fY \\ Z \end{pmatrix} = \begin{pmatrix} f & 0 & 0 & 0 \\ 0 & f & 0 & 0 \\ 0 & 0 & 1 & 0 \end{pmatrix} \begin{pmatrix} X \\ Y \\ Z \\ 1 \end{pmatrix}  
	$$  
	即$x = PX$  
	$P=\text{diag}(f, f, 1) [I|0]$，其中 $\text{diag}(f, f, 1)$ 是对角矩阵，而 $[I|0]$ 表示矩阵分块成一个 $3 \times 3$ 块（单位矩阵）加上一个列向量  
	由此f是基本投影的效果  
- 主点偏移（+2dof）  
	主点在像平面坐标不为原点而是$(p_x, p_y)^T$，即光心在世界坐标系坐标为$(p_x, p_y, any)^T$  

	$$  
	\begin{pmatrix} fX + Zp_x \\ fY + Zp_y \\ Z \end{pmatrix} = \begin{pmatrix} f & 0 & p_x & 0 \\ 0 & f & p_y & 0 \\ 0 & 0 & 1 & 0 \end{pmatrix} \begin{pmatrix} X \\ Y \\ Z \\ 1 \end{pmatrix}  
	$$  
	  
	记摄像机标定矩阵$K = \begin{pmatrix} f & 0 & p_x \\ 0 & f & p_y \\ 0 & 0 & 1 \end{pmatrix}$ 称为内参数(3dof)  
	即$x = K[I|0]X_{cam}$  
- 摄像机旋转平移（+6dof）  
	光心在世界坐标系坐标为$\tilde{\mathbf{C}}$(3dof)，世界坐标系到摄像机坐标系旋转为$R$(3dof)，称为外参数  
	当世界坐标系到摄像机坐标系变换满足$\tilde{\mathbf{X}}_{\text{cam}} = R (\tilde{\mathbf{X}} - \tilde{\mathbf{C}})$，即  

	$$\mathbf{X}_{\text{cam}} =\begin{bmatrix}R & -R\tilde{\mathbf{C}} \\ 0^T & 1 \end{bmatrix}\mathbf{X}$$  
	此时投影式为$\mathbf{x} = KR[I|-\tilde{\mathbf{C}}]\mathbf{X}$  
	令$\mathbf{t} = -R\mathbf{C}$，即$x=PX$  ，$P = K[R|\mathbf{t}]$，	$\widetilde{\mathbf{X}}_{\text{cam}} = R \widetilde{\mathbf{X}} + \mathbf{t}$  
	此时P为9dof  
- CCD摄像机（+1dof）  
	考虑像素长宽比的情况下，即将坐标系的单位长度改为像素量纲  
	即对K左乘$\text{diag}(m_x, m_y, 1)$，此时有  
	  
	$$  
	K =   
	\begin{bmatrix}  
	fm_x & 0 & m_x p_x \\  
	0 & fm_y & m_y p_y \\  
	0 & 0 & 1  
	\end{bmatrix}  
	=   
	\begin{bmatrix}  
	\alpha_x & 0 & x_0 \\  
	0 & \alpha_y & y_0 \\  
	0 & 0 & 1  
	\end{bmatrix}  
	$$	  
	  
	P为10dof  
- 有限射影摄像机（+1dof）  
	加入扭曲参数s，K为5dof  
	  
	$$K =   
	\begin{bmatrix}  
	\alpha_x & s & x_0 \\  
	0 & \alpha_y & y_0 \\  
	0 & 0 & 1  
	\end{bmatrix}  

	$$  
	此时P为11dof，$P = [M|\mathbf{p}_4] = KR[I|-\tilde{\mathbf{C}}]$，M=KR，$p_4$为P第4列  
	P的左3\*3即KR为非奇异矩阵等价于是有限射影摄像机矩阵  
	非奇异矩阵M可以RQ分解得到上三角矩阵与旋转矩阵  
	（非奇异方阵一定满秩）  
- 一般射影摄像机  
	在有限射影摄像机矩阵基础上，行满秩的任意3\*4矩阵即为一般射影摄像机矩阵  
	（去掉非奇异约束）  
#### 总结  
摄像机模型P由三维仿射变换、投影、二维仿射变换组成  
- 三维仿射变换：外参  
- 二维仿射变换：内参  
- 投影：  
	- 有限摄像机：  
	  
		$$\begin{bmatrix} 1 & 0 & 0 & 0 \\ 0 & 1 & 0 & 0 \\ 0 & 0 & 1 & 0 \end{bmatrix}$$  
	- 仿射摄像机：  
	  
		$$\begin{bmatrix} 1 & 0 & 0 & 0 \\ 0 & 1 & 0 & 0 \\ 0 & 0 & 0 & 1 \end{bmatrix}$$  
		  
	  
  
## 射影摄像机  
#### 性质  
$P = [M|\mathbf{p}_4]$     3 * 4  
- 光心：世界坐标系的齐次坐标为C，$PC = 0$，即该点投影无定义  
	- 有限摄像机（$M$ 非奇异）  
	   
		$$C = \begin{pmatrix}-M^{-1}p_4 \\1\end{pmatrix}$$  
		  
	- 无穷远摄像机（$M$ 奇异）  
	  
		$$C = \begin{pmatrix}\mathbf{d} \\0\end{pmatrix}$$  
	  
		$\mathbf{d}$ 是 $M$ 的 3 维零向量，即 $M\mathbf{d} = 0$  
		此时光心在无穷远处  
- 列点  
	$i = 1, \cdots, 3$  
	列向量 $\mathbf{p}_i$ 对应世界坐标系的 $X, Y, Z$ 轴在图像上的消影点  
	列 $\mathbf{p}_4$ 是世界坐标系原点在像平面的齐次坐标  
- 主平面：摄像机的主平面是 $P$ 的第三行 $P^{3T}$  
- 轴平面：  
	平面 $P^{1T}$ 和 $P^{2T}$（$P$ 的第一和第二行）分别映射到像平面坐标系XY轴  
	均过摄像机中心  
	两轴平面交线为光心与像平面原点连线，不重合主轴  
- 主点：$\mathbf{x}_0 = M\mathbf{m}^{3T}$，$\mathbf{m}^{3T}$ 是 $M$ 的第三行  
- 主轴：  
	过摄像机中心 $C$ 而方向向量为 $\mathbf{m}^{3T}$ 的射线  
	主轴向量 $\mathbf{v} = \det(M)\mathbf{m}^{3T}$ 指向摄像机的前方  
  
#### 作用于点  
- 空间点到图像点的正向投影  $\mathbf{x}=P\mathbf{X}$  
- 图像点到空间射线的反向投影  
	- 一般摄像机  
		矩阵P的伪逆定义为$P^+ = P^T (PP^T)^{-1}$，有$PP^+ = I$（伪逆的优点是不要求矩阵为方阵）  
		$P(P^+ \mathbf{x}) = I\mathbf{x} = \mathbf{x}$，因此空间点$P^+ \mathbf{x}$投影到x上  
		由空间点$P^+ \mathbf{x}$和光心C确定反向投影的射线为$$\mathbf{X}(\lambda) = P^+ \mathbf{x} + \lambda C$$  
	- 有限摄像机  
		光心$\tilde{\mathbf{C}} = -M^{-1} \mathbf{p}_4$  
		无穷远点$\mathbf{D} = ((M^{-1} \mathbf{x})^T, 0)^T$投影到x  
		由此确定射线为  
		  
		$$\mathbf{X}(\mu) =\mu D+ C=\begin{pmatrix}	M^{-1} (\mu \mathbf{x} - \mathbf{p}_4) \\1\end{pmatrix}$$  
		  
- 空间点的深度（仅对有限摄像机）  
	即点到主平面的距离，且通过正负体现位置前后  
	- 已归一化摄像机矩阵  
		$\det(M)>0$且$\|\mathbf{m}^3\| = 1$，即$\mathbf{m}^3$ 是指向正轴向的单位向量  
		光心到点的射线向量点乘主轴向量等于深度  
		即$$w = \mathbf{m}^{3T}(\tilde{\mathbf{X}} - \tilde{\mathbf{C}})$$  
	- 未归一化摄像机矩阵  
		对点$\mathbf{X} = (X, Y, Z, T)^T$和有限摄像机$P = [M | \mathbf{p}_4]$  
		$P(X, Y, Z, T)^T = w(x, y, 1)^T$  
		$$\text{depth}(\mathbf{X}; P) = \frac{\text{sign}(\det M)w}{T \| \mathbf{m}^3 \|}$$  
		且depth在缩放X或P时保持不变  
  
#### 分解摄像机矩阵  
从矩阵还原参数  
- 光心  
	由$PC = 0$  
	有$X = \det([\mathbf{p}_2, \mathbf{p}_3, \mathbf{p}_4])$，$\quad Y = -\det([\mathbf{p}_1, \mathbf{p}_3, \mathbf{p}_4])$，$Z = \det([\mathbf{p}_1, \mathbf{p}_2, \mathbf{p}_4])$，$\quad T = -\det([\mathbf{p}_1, \mathbf{p}_2, \mathbf{p}_3])$  
- 内外参（有限摄像机）  
	RQ分解M=KR，并保证K为正上三角矩阵  
  
#todo 欧式坐标系与射影坐标系的影响，摄像机是欧式装置  
  
## 无穷远摄像机  
#### 仿射摄像机$P_{\infty}$  
定义：满足$\mathbf{P}^{3T}=(0,0,0,1)$的摄像机  
将无穷远点映射到无穷远点  
主轴方向为$\mathbf{r}^3$  
此摄像机中各投影线平行（交于光心这个无穷远点，所以平行）  
不断拉远相机并增加焦距，使有限摄像机变为仿射摄像机，矩阵为  
$$P_{\infty} = \lim_{t \to \infty} P_t = K   
\begin{bmatrix}  
\mathbf{r}^{1T} & -\mathbf{r}^{1T}\widetilde{C} \\  
\mathbf{r}^{2T} & -\mathbf{r}^{2T}\widetilde{C} \\  
\mathbf{0}^T & d_0  
\end{bmatrix}$$  
$d_0=-\mathbf{r}^{3T}\widetilde{C}$为世界原点到摄像机中心在主射线方向上的距离  
$P_{\infty}$没有主点，因此分解为   
   
$$P_\infty = \begin{bmatrix} K_{2 \times 2} & 0 \\ 0^T & 1 \end{bmatrix} \begin{bmatrix} \hat{R} & \hat{t} \\ 0^T & 1 \end{bmatrix}$$  
  
  
- 对比有限摄像机  
	- 透视结果位置对比  
		点 $X$ 离该平面的垂直距离是 $\Delta$  
		$P_0$主点为$\mathbf{\tilde{x}}_0$  
		$$K = \begin{bmatrix} K_{2 \times 2} & \mathbf{\tilde{x}}_0 \\ \mathbf{0}^T & 1 \end{bmatrix}$$  
		被摄像机 $P_0$ 和 $P_\infty$ 分别影像到  
		$$\mathbf{\tilde{x}}_{proj} = P_0 X = K \begin{pmatrix} \tilde{x} \\ \tilde{y} \\ d_0 + \Delta \end{pmatrix} \quad \mathbf{\tilde{x}}_{\text{affine}} = P_\infty X = K \begin{pmatrix} \tilde{x} \\ \tilde{y} \\ d_0 \end{pmatrix}$$  
		式中，$\tilde{x} = \alpha - \mathbf{r}^{1T} \widetilde{C}$，$\tilde{y} = \beta - \mathbf{r}^{2T} \widetilde{C}$  
		则  
		$$\mathbf{\tilde{x}}_{\text{affine}} - \mathbf{\tilde{x}}_0 = \frac{d_0 + \Delta}{d_0} (\mathbf{\tilde{x}}_{proj} - \mathbf{\tilde{x}}_0)$$  
		即$$\mathbf{\tilde{x}}_{\text{affine}} - \mathbf{\tilde{x}}_{proj} = \frac{\Delta}{d_0} (\mathbf{\tilde{x}}_{proj} - \mathbf{\tilde{x}}_0)$$  
		因此深度的起伏（$\Delta$）相对平均深度（$d_0$）较小且点离主轴的距离较小时仿射摄像机与有限摄像机透视位置相差不大  
	- 平行投影矩阵 $\begin{bmatrix} K_{2 \times 2} & 0 \\ 0^T & 1 \end{bmatrix}$ 代替了有限摄像机的规范射影矩阵 $[I|0]$  
	- 标定矩阵 $\begin{bmatrix} K_{2 \times 2} & 0 \\ 0^T & 1 \end{bmatrix}$ 代替了有限摄像机的 $K$   
	- 主点无定义  
  
#### 一般无穷远摄像机  
光心为无穷远点，但主平面不是无穷远平面  
$M_{3 \times 3}$同样是奇异矩阵，但是第三行不是全0  
  
  
  
  
## 其他摄像机  
#### LP摄像机（线阵推扫式）  
对比一般摄像机：  
一般摄像机视锥为四棱锥，摄像机固定在顶点上  
LP摄像机视锥为三棱柱，摄像机沿着一条母线移动  
  
因此投影时摄像机矩阵相同， 但xy中和母线平行的维度在投影时保持不变  
  
#### 线阵摄像机  
二维到一维投影  
$P_{2 \times 3} = K_{2 \times 2} R_{2 \times 2} [I_{2 \times 2} | - \overline{c}]$  
  
$$K_{2 \times 2} = \begin{pmatrix} a_x & x_0 \\ 0 & 1 \end{pmatrix}$$  
  
  
  
## 参数估计  
参考[[4. 估计]]的估计单应  
#### 基本方程  
对于对应$X_i \leftrightarrow x_i$，有$x_i=P X_i$，即$x_i \times PX_i=0$，$P^{iT}$为P的第i行，即  
$$\begin{bmatrix} 0^T & -w_i X_i^T & y_i X_i^T \\ w_i X_i^T & 0^T & -x_i X_i^T \\ -y_i X_i^T & x_i X_i^T & 0^T \end{bmatrix} \begin{bmatrix} P^1 \\ P^2 \\ P^3 \end{bmatrix} = 0$$  
左矩阵三行线性相关，与单应估计同理，省去一行，有  
$$\begin{bmatrix} 0^T & -w_i X_i^T & y_i X_i^T \\ w_i X_i^T & 0^T & -x_i X_i^T \end{bmatrix} \begin{bmatrix} P^1 \\ P^2 \\ P^3 \end{bmatrix} = 0$$  
同样通过n组对应形成2n\*12矩阵A，即Ap=0  
#### 超定  
最小化代数/几何误差  
- 代数误差：  
	残差Ap记为代数误差  
	在满足某归一化时，约束$\| p\|=1$或者$\|\hat{p}^3\|=1$（$\|\hat{p}^3\|$为P第三行前三元素）  
	等价于  
	$$\sum_i d(X_i,X'_i)^2$$  
#### 归一化  
- 点比较集中时，移动使形心位于原点，缩放使各点到原点距离均方根为$\sqrt{3}$  
- 点分散且有些接近无穷远时，归一化点集$x_i = (x_i, y_i,z_i,w_i)$  
	使得 $$\sum x_i = \sum y_i = \sum z_i = 0; \quad \sum (x_i^2 + y_i^2 +z_i^2)= 3\sum w_i^2; \quad x_i^2 + y_i^2 + z_i^2 + w_i^2 = 1, \forall i$$  
	此时形心不在原点  
  
  
#### 几何误差  
- 目标  
	给定 $n \geq 6$ 组由世界到图像的点对应 $\{X_i \leftrightarrow x_i\}$，确定摄像机投影矩阵 $P$ 的最大似然估计，即求最小化 $\sum_i d(x_i, P X_i)^2$ 的 $P$。  
- 算法  
	(1) 线性解。用诸如算法4.2的线性算法计算 $P$ 的一个初始估计：  
		(a) 归一化：用一个相似变换 $T$ 去归一化图像点，而用第二个相似变换 $U$ 去归一化空间点。设归一化后的图像点是 $\tilde{x}_i = T x_i$，归一化后的空间点是 $\tilde{X}_i = U X_i$。  
		(b) DLT：把每组对应 $\tilde{x}_i \leftrightarrow \tilde{X}_i$ 产生的方程组并起来形成一个 $2n \times 12$ 矩阵 $A$。记 $p$ 为矩阵 $P$ 的元素构成的向量。$Ap = 0$ 的满足 $\|p\| = 1$ 的解是 $A$ 的对应于最小奇异值的单位奇异向量。  
	(2) 最小化几何误差。以线性估计为初始点，在 $P$ 上用诸如 Levenberg-Marquardt 的迭代算法最小化几何误差式： $$\sum_i d(\tilde{x}_i, \tilde{P} \tilde{X}_i)^2$$  
	或者$$\sum_{i=1}^n d_{\text{Mah}}(x_i, P \hat{X}_i)^2 + d_{\text{Mah}}(X_i, \hat{X}_i)^2$$  
	取决于世界坐标（实际物体）测量准确度  
	(3) 解除归一化。由 $P$ 求原（未归一化）坐标系下的摄像机矩阵，即 $$P = T^{-1} \tilde{P} U$$  
  
获取图像点$x_i$方法：canny边缘检测，对边缘拟合得到直线，直线相交得到$x_i$  
  
#### 仿射摄像机估计  
**相当于估计约束条件为$P^{3T}=(0,0,0,1)$的P**  
  
点归一化为$X_i = (X_i, Y_i, Z_i, 1)^T, x_i = (x_i, y_i, 1)^T$后，由于仿射摄像机的$P^{3T}=(0,0,0,1)$  
单组对应的方程简化为$$\begin{bmatrix} \mathbf{0}^T & -X_i^T \\ X_i^T & \mathbf{0}^T \end{bmatrix} \begin{bmatrix} \mathbf{P}^1 \\ \mathbf{P}^2 \end{bmatrix} + \begin{bmatrix} y_i \\ -x_i \end{bmatrix} = 0$$  
此时代数误差平方等于几何误差平方  
$$\| \mathbf{A} \mathbf{p} \|^2 = \sum_i (x_i - \mathbf{P}^{1T} X_i)^2 + (y_i - \mathbf{P}^{2T} X_i)^2 = \sum_i d(x_i, \hat{x}_i)^2$$  
- 目标  
	给定 $n \geq 4$ 组世界到图像的点对应 $\{X_i \leftrightarrow x_i\}$，确定仿射摄像机投影矩阵 $P_A$ 的最大似然估计，即求在仿射约束 $P^{3T} = (0,0,0,1)$ 下最小化 $\sum d(x_i,PX_i)^2$ 的摄像机 $P$。  
- 算法  
	(1) 归一化：用一个相似变换 $T$ 归一化图像点，而用第二个相似变换 $U$ 来归一化空间点。假定  
	归一化后的图像点是 $\tilde{x}_i = Tx_i$，而归一化后的空间点是 $\tilde{X}_i = UX_i$，其最后一个元素是 1。  
	(2) 每组对应 $\tilde{X}_i \leftrightarrow \tilde{x}_i$ 产生方程 $$\begin{bmatrix} \tilde{X}_i^T & 0^T \\ 0^T & \tilde{X}_i^T \end{bmatrix} \begin{bmatrix} \tilde{P}^1 \\ \tilde{P}^2 \end{bmatrix} = \begin{bmatrix} \tilde{x}_i \\ \tilde{y}_i \end{bmatrix}$$ 把它们全起来形成一个 $2n \times 8$ 的矩阵方程 $A_8 p_8 = b$，其中 $p_8$ 为包含矩阵 $\tilde{P}_A$ 前两行的 8 维向量。  
	(3) 解出 $A_8$ 的伪逆给出： $$p_8 = A_8^*b$$ 并且 $\tilde{P}^{3T} = (0,0,0,1)$。  
	(4) 解除归一化：原（未归一化）坐标系下的摄像机矩阵由 $\tilde{P}_A$ 求得，即 $$P_A = T^{-1} \tilde{P}_A U$$  
#### 受限摄像机估计  
#todo 理解该节p160  
- 最小化几何误差  
	约束部分参数后，用剩下参数参数化摄像机矩阵，然后迭代最小化  
- 最小化代数误差  
	有映射g将参数集q映射到摄像机矩阵P，此时最小化代数误差等价于最小化$\|Ag(q)\|$  
- 简化测量矩阵  
	用12\*12的矩阵$\hat{A}$代替2n\*12的A，使得对任何向量 $p$ 有 $\|Ap\| = p^T A^T Ap = \|\hat{A}p\|$  
	- 方法一，SVD分解A，$A=UDV^T$，令$\hat{A}=DV^T$，有$A^TA = (VDU^T)(UDV^T) = (VD)(DV^T) = \hat{A}^T\hat{A}$  
	- 方法二，QR分解A，$A=Q\hat{A}$，其中$\hat{A}$为上三角矩阵  
	此时求解问题与n无关，把9到2n的映射变为9到12的映射，需要最小化的残差也变成了12个  
  
DLT求内参时可以通过软约束来固定参数  
即修改代价函数为$\sum_i d(x_i, PX_i)^2 + ws^2 + w(\alpha_x - \alpha_y)^2$  
  
#todo 协方差估计p161  
#todo 估计摄像机方差椭球  
  
#### 径向失真  
点X经外参变换为$X_{cam}$，然后无失真地线性映射为理想点$(\tilde{x}, \tilde{y}, 1)^T = [I|0] X_{cam}$  
$(x_d, y_d)$ 为经径向失真后的实际图像位置  
$\tilde{r}$ 为到径向失真中心的径向距离 $\sqrt{\tilde{x}^2 + \tilde{y}^2}$  
$L(\tilde{r})$ 是一个失真因子，它仅仅是半径 $\tilde{r}$ 的函数  
  
$$\begin{pmatrix} x_d \\ y_d \end{pmatrix} = L(\tilde{r}) \begin{pmatrix} \tilde{x} \\ \tilde{y} \end{pmatrix}$$  
  
- 矫正  
	目标：使$(\hat{x}, \hat{y})$与三维世界坐标线性关联  
	  
	$\hat{x} = x_c + L(r) (x - x_c)$，$\hat{y} = y_c + L(r) (y - y_c)$  
	$(x, y)$是测量的坐标，$(\hat{x}, \hat{y})$是矫正后的坐标，$(x_c, y_c)$是径向失真的中心  
	$r^2 = (x - x_c)^2 + (y - y_c)^2$  
	若宽高比不为1，则求r时进行矫正  
	  
	$L(r)$仅当r为正值时有定义并且$L(0) = 1$  
	通常选泰勒展开函数近似L(r)，选光心为失真中心  
	即$L(r) = 1 + k_1 r + k_2 r^2 + k_3 r^3 + \cdots$  
	系数$\{k_1, k_2, k_3, \cdots, x_c, y_c\}$视为内参一部分  
	  
	最小化一个误差来求L(r)，可以与P一起求  
	或者在要求直线映射到图像仍为直线时，选用直线相关的代价函数，此时不需要另外标定  