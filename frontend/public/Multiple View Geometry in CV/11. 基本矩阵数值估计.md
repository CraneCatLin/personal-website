## 基本方程  
有对应点$(x, y, 1)^T$ 和 $(x', y', 1)^T$，由$x'^T Fx = 0$有  

$$x'x f_{11} + x'y f_{12} + x' f_{13} + y'x f_{21} + y'y f_{22} + y' f_{23} + x f_{31} + y f_{32} + f_{33} = 0$$  
行优先向量化F为f，则有$(x'x, x'y, x', y'x, y'y, y', x, y, 1) f = 0$  
n个这样的方程组成方程组$Af=0$，A为n\*9矩阵  
存在一个非零解时，A需要秩为8，解为右零空间生成元  
  
#### 最少点数7点  
此时A为7\*9，秩7  
A的右零空间生成元$f_1$ 和 $f_2$分别转为$F_1$ 和 $F_2$，则方程 $Af = 0$ 的解是形如 $F=\alpha F_1 + (1 - \alpha) F_2$ 的2维空间  
约束$\det F =\det (\alpha F_1 + (1 - \alpha) F_2) = 0$，即得到关于 $\alpha$ 的一个三次多项式方程，去除复解则有一或三个实解，对应一或三个F可能的解  
## 8点算法  
  
归一化8点算法：取“归一化”到“解除归一化”步骤，去掉‘奇异性约束“  
代数误差最小化同时强迫奇异约束算法：加上“迭代最小化代数误差“和“奇异性约束”步骤即可  
#### 归一化  
平移和缩放点集，使得形心位于原点 $(0,0)^T$，并且它们到原点的均方根距离是 $\sqrt{2}$  
#### 线性解  
提供8对或更多的点，组成方程组并求解  
超定时求最小二乘解f，即A的SVD分解$A=UDV^T$中V的最后一列（参考估计一章的）  
f转换回F  
#### 奇异性约束（强迫）  
基本矩阵是不满秩的（秩为2），左右零空间生成元分别为两个对极点向量  
因此利用之前求得的F，SVD分解得到$F = UDV^T$，$D = \text{diag}(r,s,t)$ 满足 $r \geq s \geq t$  
此时在约束 $\det F' = 0$ 下最小化 Frobenius 范数 $\|F - F'\|$的$F' = U \text{diag}(r,s,0) V^T$为新的解  
$F'$代替$F$  
#### 解除归一化  
反向即可  
由此得到初始解$F_0$及其右零向量$e_0$  
#### 迭代最小化代数误差  
$e_i = e_0$为起点  
基本矩阵可以写成$F = M[e]_\times$，非奇异乘反对称的形式。行优先向量化F和M后有$f = Em$，$$E = \begin{bmatrix}[e]_\times & 0 & 0 \\0 & [e]_\times & 0 \\0 & 0 &[e]_\times\end{bmatrix}$$  
此时在约束条件 $\|E_i m_i\| = 1$ 下，求最小化 $\|AE_im_i\|$的$f_i = E_i m_i$  
计算代数误差 $\epsilon_i = Af_i$，（必要时）乘-1修正 $\epsilon_i$ 的符号使得当 $i > 0$ 时 $\epsilon_i^T \epsilon_{i-1} > 0$  
上述内容定义了 $\mathbb{R}^3 \to \mathbb{R}^9$ 的一个映射：$e_i \mapsto \epsilon_i$。现在用 Levenberg-Marquardt 算法迭代变化 $e_i$ 以最小化 $\|\epsilon_i\|$  
收敛时的$f_i$ 代表所求的基本矩阵  
  
## 几何距离  
3种算法：非线性最小化的初始化+代价函数参数化  
高斯噪声假设下黄金标准最优但是代价较大  
  
  
#### 黄金标准  
假设噪声分布符合高斯分布  
此时ML估计最小化几何距离，即重投影误差$\sum_{i} d(x_i, \hat{x}_i)^2 + d(x'_i, \hat{x}'_i)^2$  
$x_i \leftrightarrow x'_i$ 是所测量的对应  
$\hat{x}_i\leftrightarrow \hat{x}'_i$ 是估计的且准确满足 $\hat{x'}_i^T F\hat{x}_i = 0$  
$F$ 为估计的秩为 2 的基本矩阵  
  
定义一对摄像机矩阵 $P = [I|0]$ 和 $P' = [M|t]$，三维点 $X_i$  
令 $\hat{x}_i = PX_i$ 和 $\hat{x}'_i = P'X_i$，改变 $P'$ 和点 $X_i$ 以最小化误差表达式  
$F = [t]_\times M$   
向量 $\hat{x}_i$ 和 $\hat{x}'_i$ 将满足 $\hat{x'}_i^T F\hat{x}_i = 0$  
用Levenberg-Marquardt 算法最小化误差  
  
参数的初始估计用归一化的 8 点算法计算，然后按第 12 章介绍的方法进行射影重构。因此，用这种方法估计基本矩阵实际上等价于射影重构。  
  
采用稀疏的 LM 技术以大幅降低开销，详见A6.5 #todo   
  
**算法**  
给定 $n \geq 8$ 组图像点对应 $\{x_i \leftrightarrow x_i'\}$，确定基本矩阵的最大似然估计$\hat{F}$。  
MLE 同时还求满足 $\hat{x}_i'^T \hat{F} \hat{x}_i = 0$ 的辅助点对应集合 $\{\hat{x}_i \leftrightarrow \hat{x}_i'\}$，并且最小化  

$$\sum_i d(x_i, \hat{x}_i)^2 + d(x_i', \hat{x}_i')^2$$  
步骤：  
- 用线性算法（如归一化8点算法）来计算 $\hat{F}$ 的一个秩为 2 的初始估计。  
- 计算辅助变量 $\{\hat{x}_i, \hat{x}_i'\}$ 的初始估计如下：  
	- 选择摄像机矩阵 $P = [I \mid 0]$ 和 $P' = [[e']_\times \hat{F} \mid e']$，其中 $e'$ 由 $\hat{F}$ 得到。  
	- 用第 12 章的三角测量法，由对应 $x_i \leftrightarrow x_i'$ 和 $\hat{F}$ 确定 $\hat{X}_i$ 的一个估计。  
	- 与 $\hat{F}$ 相容的对应是 $\hat{x}_i = P \hat{X}_i, \hat{x}_i' = P' \hat{X}_i$。  
- 在 $\hat{F}$ 和 $\hat{X}_i$ 上，$i = 1, \cdots, n$，最小化代价函数  

$$\sum_i d(x_i, \hat{x}_i)^2 + d(x_i', \hat{x}_i')^2$$  
	用 Levenberg-Marquardt 算法来最小化这个代价，它有 $3n + 12$ 个变量；$3n$ 来自于 $n$ 个 3D 点 $\hat{X}_i$，而 12 来自于摄像机矩阵 $P' = [M \mid t]$，同时 $\hat{F} = [t]_\times M$ 且 $\hat{x}_i = P \hat{X}_i, \hat{x}_i' = P' \hat{X}_i$。  
  
  
#### 秩2矩阵F的参数化  
**超参数化**  
$P = [I|0]$ 和 $P' = [M|t]$情况下有$F = [t]_\times M$  
其中 $M$ 是任意 $3 \times 3$ 矩阵  
$[t]_\times$ 是奇异矩阵，因此F为奇异矩阵  
此时有t（3）和M（9）共12个参数  
  
**对极参数化（单对极点）**  
F秩2，由此可写为两列加两个参数，第三列由前两列表示：$f_3 = \alpha f_1 + \beta f_2$，共8个参数  
  
$$F = \begin{bmatrix}  
a & b & \alpha a + \beta b \\  
c & d & \alpha c + \beta d \\  
e & f & \alpha e + \beta f  
\end{bmatrix}$$  
  
若将$f_1$和$f_2$中绝对值最大参数设为1（这样结果最好），此时得到最小参数化集合，有7个参数  
同理可以选择另外两列  
  
出现奇异性的特殊情况：  
若右对极点为消影点，有$Fe = F(e_1, e_2, 0)^T = 0$，此时$f_1$和$f_2$线性相关  
当选取另外两列时，若对极点在一个坐标轴上时会出现奇异性  
  
通过检测对极点来判断奇异性，可以通过更换参数化方法来规避奇异性  
  
$(\alpha, \beta, -1)^T$ 是这个基本矩阵的右对极点，因此这种参数化可以概括为两列加单个对极点参数化  
  
**双对极点参数化**  
参考单对极点，有双对极点$(\alpha, \beta, -1)^T$ 和 $(\alpha', \beta', -1)^T$参数化：  
$$F = \begin{bmatrix}  
a & b & \alpha a + \beta b \\  
c & d & \alpha c + \beta d \\  
\alpha' a + \beta' c & \alpha' b + \beta' d & \alpha' \alpha a + \alpha' \beta b + \beta' \alpha c + \beta' \beta d  
\end{bmatrix}$$  
同理取左上4参数中绝对值最大参数为1  
同理有类似奇异性情况，避免方法为在F中取不同位置的$2 \times 2$ 矩阵（参考余子阵）  
  
#### Sampson距离（一阶几何误差）  
提供几何距离的一阶近似  
参考估计章节的公式，$\delta_x = -J^T(JJ^T)^{-1}\epsilon$  
此处代数误差为$\epsilon={x'}_i^T F x_i$  
偏导矩阵为$$J = \begin{bmatrix}  
\frac{\partial (x'^T Fx)}{\partial x} & \frac{\partial (x'^T Fx)}{\partial x'}  
\end{bmatrix}$$  
由此$$JJ^T = (Fx_i)_1^2 + (Fx_i)_2^2 + (F^T x_i')_1^2 + (F^T x_i')_2^2$$  
Sampson误差为范数 $\|\delta_x\|^2$ ，即  

$$\sum_i \frac{(x_i'^T Fx_i)^2}{(Fx_i)_1^2 + (Fx_i)_2^2 + (F^T x_i')_1^2 + (F^T x_i')_2^2}$$  
若$x$为$e$而$x'$为$e'$，即在由两个对极点确定的 $\mathbb{R}^4$ 空间中的点时，$JJ^T = 0$，近似无定义，需要避免  
  
优点：  
仅需要F本身的参数而不引入其他点的辅助变量，即不需要 $n$ 个空间点 $X_i$ 的坐标。从而把一个 $7 + 3n$ 个自由度的最小化问题减少为一个只有 7 个自由度的问题  
  
## 算法评估  
  
共N组点，选n组用于各算法估计  
计算残差，评估残差关于n的曲线  
此处残差可以取  

$$\frac{1}{N} \sum_{i}^{N} \left[ d(x_i', Fx_i)^2 + d(x_i, F^T x_i')^2 \right]$$  
d表示点到直线距离  
  
评估的残差与各算法的残差不能相同  
评估要在全集范围内而非选取估计范围内  
  
#### 结论  
- 不使用未归一化8点算法  
- 归一化8点算法 本身简易且结果足够好，同时可作为算法第一步初始解  
- 提高准确性使用迭代最小化代数误差或Sampson误差算法，二者效果类似  
- 高斯噪声假设成立时，效果最好的是黄金标准算法  
  
  
## F自动计算  
参考估计章节的RANSAC，计算两幅图之间的基本矩阵  
#### 算法  
- 兴趣点：在每幅图像中计算兴趣点。  
- 假设对应：利用兴趣点的灰度邻域的相近和相似计算它们的匹配集。  
- RANSAC 鲁棒估计：重复 $N$ 次采样，其中 $N$ 用RANSAC自适应方法确定：  
	- 选择 7 组对应构成的一个随机样本并按”最小点数7点算法“来计算基本矩阵 $F$。将得到一个或三个实解。  
	- 对每组假设对应计算距离 $d_\perp$。  
	- 计算与 $F$ 一致的内点数，即满足 $d_\perp < t$ 像素的对应的数目。  
	-  如果 $F$ 有三个实解，计算每一个解的内点数并保留具有最多内点数的解。  
	- 选择具有最多内点数的 $F$。在数目相等时，选择内点标准差最小的那个解。  
- 非线性估计：利用Levenberg-Marquardt 算法最小化某个代价函数（如重投影误差），由划为内点的所有对应重新估计 $F$。  
- 引导匹配：利用所估计的 $F$ 定义对极线附近的搜索区域，以便进一步确定兴趣点的对应。最后两步可以反复迭代直到对应的数目稳定为止。  
#### RANSAC样本数  
选7组对应计算而非8组  
优点：  
计算得到的F自然是秩2的，不需要强迫约束  
N次采样中大概率有至少一次采样无野值所需的N与样本数量有指数函数关系，减少样本效果显著  
缺点：  
7组对应计算出的三个解都要检验  
#### 距离测量  
所计算的距离$d_\perp$是用于体现匹配点接近符合对极几何的程度  
可以选择重投影误差，或者重投影误差的Sampson近似；但是这里选择的距离要与非线性估计步骤中迭代估计的代价函数相同  
  
#### 引导匹配  
这个步骤中，利用已知的F可以得知x的对应点在对极线Fx附近  
可以根据这条线划出一个线状搜索带，则仅在这个范围内搜索时可以减小相似性阈值，取一个相对较优即可，不需要担心减小阈值导致严重错配  
  
  
## F计算的特殊情况  
本节参考第9章  
#### 纯平移  
$F =[e']_\times$，此时约束为反对称，同时自动约束dof为2  
用$e'$的三个元素参数化  
纯平移下基于点对应的对极点的黄金标准估计，等于在给定一组成像平行线的端点下对消影点的估计  
  
#### 平面运动  
同时约束F和F的对称矩阵秩2，6dof  
两种可选的参数化为  
$F = [e']_\times [l_s]_\times [e]_\times$  
此时三个三维量共9个参数，超定但是可用  
$F = \alpha [x_a]_\times + \beta (l_s l_h^T + l_h l_s^T), \quad \text{且} \quad x_a^T l_h = 0$  
具体符号解释参考第9章基本矩阵几何解释  
#todo   
#### 已标定摄像机  
此时归一化坐标后，可以改为计算本质矩阵  
本质矩阵可以采用与基本矩阵类似的8点算法  
区别：  
强迫约束时，除了基本矩阵的def F=0，还有两个奇异值要相等  
  
设 $E$ 是一个 SVD 为 $E = UDV^T$ 的 $3 \times 3$ 矩阵，其中 $D = \text{diag}(a,b,c)$ 且 $a \geq b \geq c$  
则在 Frobenius 范数下最接近 $E$ 的本质矩阵是 $\hat{E} = U\hat{D} V^T$，其中 $\hat{D} = \text{diag}((a+b)/2,(a+b)/2,0)$  
若目标是重构出两个摄像机，则可以参考第9章“由E恢复摄像机矩阵”，由E的SVD分解直接计算摄像机矩阵而不需要计算$\hat{E}$  
  
## 其他元素对应  
图像上的各种对应元素  
#### 直线  
本身不能约束F  
平行线提供消影点，消影点对应等价于一个正常有限点对应，提供一个约束  
  
#### 空间曲线、曲面  
空间中的一个曲线分别映射到两个图像上，若一个像与所在图的对极线相切，则另一个像也与相应对极线相切  
  
曲面与对极平面相切时，其外形线也与对极线相切，且切点投影成立  
  
上述两种切点可以作为正常点对应使用  
## 退化  
对应点集无法确定F，也即有线性无关的若干F同时满足映射关系，则称该点集几何上关于F是退化的  
#### 概述分类  
根据基本方程A的零空间维度分类  
解空间dim=1：单个解（非退化）  
有一般的至少8组对应，且超定时必须无噪声  
  
解空间dim=2：1或3个解  
7组对应，或大于7组的无噪声对应  
其中3D 点和摄像机中心在一个被称为临界曲面的直纹二次曲面上  
二次曲面可以是非退化的(单叶双曲面)或退化的  
  
解空间dim=3：有两个参数的解族  
由一个单应关联，至少6组无噪声的对应点  
可能是退化的运动（绕光心旋转）或退化的结构（所有世界点共面）  
#### 点在直纹二次曲面上  
若两个光心和所有三维点都在临界曲面（一种直纹二次曲面）上，则为退化情况，可能有三个F解  
  
若恰有7组对应，此时7个三维点加上两个光心共9个点，总可以构造一个二次曲面  
这个二次曲面如果是直纹则为临界曲面且可能有三个解，否则只有一个解  
  
#### 点在平面上（退化的结构）  
所有三维点在一个平面上，两个光心在另一个平面上，两个平面组成一个退化的直纹二次曲面  
此时考虑共面，则两次投影等价于三个平面之间的线性变换，可以用一个2D射影变换表示两个像平面之间的关系，即$x'_i = Hx_i$  
此时F满足${x'}_i^T Fx_i = {x'}_i^T (FH^{-1}) x'_i = 0$  
则$FH^{-1}$ 需要是反对称矩阵，即F是是形如 $F = SH$ 的任何矩阵，S为反对称矩阵  
$S$ 可以记成 $S = [t]_\times$ 的形式，向量 $t$ 是任意 3 维向量，因此S为3dof，F同样  
#### 无平移（退化的运动）  
此时由公式$F=[m]_\times M$等会得到F为0  
如果非要计算F，仍可以使用8点算法等  
此时可以参考第8章“光心与移动像平面的效果”中的“旋转摄像机”  
  
## F计算的几何解释  
基本矩阵的计算与二次曲线拟合相似  
具体内容待补充，暂跳过 #todo   
  
## 对极线的包络  
已知一个像点x，寻找其对应点时可以用基本矩阵F求其对应的对极线，然后再对极线附近搜索  
利用基本矩阵的协方差矩阵确定这个搜索区域  
  
结论如下：  
如果 $l$ 是服从均值为 $\bar{l}$，协方差矩阵为秩 2 矩阵 $\Sigma_l$ 的高斯分布的随机直线，则平面二次曲线  

$$C = \bar{l} \bar{l}^T - k^2 \Sigma_l $$  
表示一个等似然轮廓，它围住了直线 $l$ 的所有事件中的某一部分。如果 $F_2(k^2)$ 表示累积 $\chi_2^2$ 分布，且选择 $k^2$ 使得 $F_2(k^2) = \alpha$，则所有直线中占 $\alpha$ 比例的部分落在由 $C$ 所界定的区域内。也就是说这些直线落在这个区域的概率是 $\alpha$  
  
证明含与第5章相关内容，暂略过，待补充 #todo   
  
## 图像矫正  
为了使对极线共面，且对极线平行于x轴，使得搜索可以在一维变量上进行而不需要在二维范围内搜索，对图像进行二维射影变换和插值等，即重采样  
#### 映射对极点到无穷远点  
如果对极线被变换为平行于 $x$ 轴的直线，则对极点应该被映射到特定的无穷远点 $(1,0,0)^T$  
满足要求的映射H还留有4dof  
为避免严重射影失真，对二维映射H作一些限制  
  
一个条件是H对图像给定点 $x_0$ 的邻域的作用尽可能地是一个刚体变换，即在一阶近似程度上，$x_0$ 的邻域只被旋转和平移，因此重采样后图像与原图像看起来相同  
点 $x_0$ 的一种适当选择是取图像的中心  
  
假定 $x_0$ 是原点且对极点 $e = (f, 0, 1)^T$ 在 $x$ 轴上，有变换  

$$G = \begin{bmatrix}1 & 0 & 0 \\0 & 1 & 0 \\-1/f & 0 & 1\end{bmatrix}$$  
该变换把对极点 $(f, 0, 1)^T$ 变到无穷远点 $(f, 0, 0)^T$  
点 $(x, y, 1)^T$ 被 $G$ 映射到点 $(\hat{x}, \hat{y}, 1)^T = (x, y, 1 - x/f)^T$，若 $|x/f| < 1$，则  

$$(\hat{x}, \hat{y}, 1)^T = (x, y, 1 - x/f)^T = (x(1 + x/f + \cdots), y(1 + x/f + \cdots), 1)^T$$  
其 Jacobi 矩阵是  

$$\frac{\partial (\hat{x}, \hat{y})}{\partial (x, y)} = \begin{bmatrix}1 + 2x/f & 0 \\y/f & 1 + x/f\end{bmatrix}$$  
外加 $x$ 和 $y$ 的高阶项  
若在原点处即$x = y = 0$，此时G一阶近似于恒等映射I  
  
由此任意位置上的兴趣点 $x_0$ 和对极点 $e$，$T$ 是把点 $x_0$ 映到原点的平移，$R$ 是一个绕原点的旋转并使对极点 $e'$ 转到 $x$ 轴上的点 $(f, 0, 1)^T$，则映射$x_0$到无穷远点的映射为$H = GRT$  
这个复合映射是在 $x_0$ 邻域内的一个刚体变换的一阶近似  
  
#### 匹配变换  
在第一副图中映射对极点到无穷远点后，利用另一个映射使得第二幅图像的对极线与第一幅图像的对极线匹配  
有两幅图像$J$和$J'$，$l$ 和 $l'$ 是两幅图像中任何一对对应的对极线；将变换$H$作用于$J$并将$H'$作用于$J'$，需要使得$H^{-T}l = H'^{-T}l'$，即对极线匹配；满足要求的一对变换称为一个变换匹配对  
  
方法：先选择某个变换 $H'$ 把对极点 $e'$ 映到无穷远点。然后寻求最小化距离平方和$\sum_{i} d(Hx_i, H'x_i')^2$的H  
  
**求匹配H‘的H**  
设 $J$ 和 $J'$ 是具有基本矩阵 $F = [e']_\times M$ 的两幅图像，并设 $H'$ 是 $J'$ 的一个射影变换。则 $J$ 的一个射影变换 $H$ 与 $H'$ 匹配当且仅当对某个向量 $a$，$H$ 具有形式  

$$H = (I + H'e'a^T)H'M$$  
  
这个结论的特殊形式是  
设 $J$ 和 $J'$ 是具有基本矩阵 $F = [e']_\times M$ 的图像，并设 $H'$ 是 $J'$ 的把对极点 $e'$ 映到无穷远点 $(1,0,0)^T$ 的一个射影变换。则 $J$ 的一个变换 $H$ 与 $H'$ 匹配当且仅当 $H$ 的形式为 $H = H_A H_0$，其中 $H_0 = H'M$，而 $H_A$ 是形如下式的一个仿射变换  

$$H_A = \begin{bmatrix} a & b & c \\ 0 & 1 & 0 \\ 0 & 0 & 1 \end{bmatrix}$$  
此时最小化$\sum_{i} d(Hx_i, H'x_i')^2$即寻找上述形式并使得$\sum_i d(H_A \hat{x}_i, \hat{x}_i')^2$最小化的$H_A$  
  
#### 算法总结  
输入：一对有重叠区域的图像  
输出：二者对极线均与x轴平行，对应点尽可能接近，视差仅在x轴  
步骤：  
- 通过自动方法等确定至少7个匹配点对，越多越好   
- 计算F并确定两个对极点  
- 选择一个把对极点 $e'$ 映射到无穷远点 $(1,0,0)^T$ 的射影变换 $H'$，参考12章  
- 求最小化最小二乘距离$\sum_i d(Hx_i, H'x'_i)^2$的匹配射影变换 $H$，方法参考“匹配变换”  
- 根据$H$和$H'$分别重采样第一和第二幅图像  
  
#### 仿射矫正  
以上内容同样适用于仿射重采样  
此时两个摄像机由仿射摄像机近似，则矫正变换变为一对仿射变换，基本矩阵替换为仿射基本矩阵  
  