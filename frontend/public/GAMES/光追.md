## shadow mapping  
判断点光源、相机分别能否直接到达某点  
记录深度图A（光源视角），然后在观测摄像机视角判断像素在自己深度最上层后，去比较该像素离光源距离和像素对应图A上的点的深度。  
硬阴影的阴影边缘锐利。反之软阴影，此时光源不是点光源  
此处深度图A即shadow map  
  
## 假设：  
光沿直线传播  
光不碰撞干涉  
光从光源到人眼，光路可逆  

  
## Whitted style  
eye ray：从相机到像素连线并延长，直到最近的与物体的交点  
shadow ray：该交点到光源连线，用于判断阴影、着色  
  
$$
\begin{gathered}
&\text{光源坐标记为 }\mathbf{o}\text{，光线方向记为 }\mathbf{d}\text{，则 }t\text{ 时间时点 }\mathbf{r}\text{ 的坐标}\\
&\mathbf{r}(t)=\mathbf{o}+t\mathbf{d}\quad(t\geq 0)\\
&\text{面方程}\\
&f(\mathbf{p})=0\\
&\text{代入即}\\
&f(\mathbf{r}(t))=0\\
&\text{或者考虑一个面的法向量 }\mathbf{N}\text{ 和面上一点 }\mathbf{p}'\text{ 有}\\
&(\mathbf{p}-\mathbf{p}')\cdot \mathbf{N}=0\\
&\text{同样代入，得到}\\
&t=\frac{(\mathbf{p}'-\mathbf{o})\cdot \mathbf{N}}{\mathbf{d}\cdot \mathbf{N}}
\end{gathered}
$$  
  
MT算法：光线和三角形求交  

$$  
\begin{gathered}  
光源坐标记为\mathbf{o}，光线方向记为\mathbf{d},则t时间时点r的坐标\\  
\mathbf{o}+t\mathbf{d}=(1-b_1-b_2)\mathbf{P_A}+b_1\mathbf{P_B}+b_2{P_C}\\ \\  
\begin{bmatrix}   
t \\   
b_1 \\   
b_2   
\end{bmatrix}   
= \frac{1}{\mathbf{S}_1 \cdot \mathbf{E}_1}   
\begin{bmatrix}   
\mathbf{S}_2 \cdot \mathbf{E}_2 \\   
\mathbf{S}_1 \cdot \mathbf{S} \\   
\mathbf{S}_2 \cdot \mathbf{d}   
\end{bmatrix}  
\\ \\  
\mathbf{E}_1 = \mathbf{P_B} - \mathbf{P_A} \\  
\mathbf{E}_2 = \mathbf{P_C} - \mathbf{P_A} \\  
\mathbf{S} = \mathbf{o} - \mathbf{P_A} \\  
\mathbf{S}_1= \mathbf{d} \times \mathbf{E}_2 \\  
\mathbf{S}_2 = \mathbf{S} \times \mathbf{E}_1  
\end{gathered}  
$$  
  
## 加速求交点：  
  
- 包围盒  
	- Axis-Aligned-Bouding Box(AABB)轴对齐包围盒  
		一条线在三对平面上，分别求相交时间（$t_{max}\& t_{min}$ ）  
		对min取最大，对max取最小->$t_{enter}=max(t_{min})$  $t_{exit}=min(t_{max})$  
		这种情况下只要保证以下条件即说明光线穿过盒子：  

		$$  
		\begin{gathered}  
			\left \{  
			\begin{array}{c}  
			t_{enter}<=t_{exit} \\  
			t_{exit}\geq0  
			\end{array}  
			\right .  
		\end{gathered}    
		$$  
		若  

		$$  
		\begin{gathered}  
			\left \{  
			\begin{array}{c}  
			t_{enter}<0 \\  
			t_{exit}>0  
			\end{array}  
			\right .  
		\end{gathered}    
		$$  
		说明线的起点在包围盒内部  
	- 普通包围盒：  
		判断光是否穿过某面，可以取面上两个基底向量（如三角形面的两条边），然后用$V=\mathbf{a}\cdot (\mathbf{b} \times \mathbf{c})$求出光线方向、两个基底向量构成的平行六面体体积，若趋于0（小于某个极小值），则可以判断光线几乎平行该面。若确定光线不平行，则求交点然后判断是否在三角形面内即可  
  
- 在盒子内部进行网格划分，先预处理得到哪些网格和物体相交，然后判断光线是否经过这些网格，经过再求交  
- 空间划分：  
	- KD-Tree：  
		划分方向沿轴方向  
		对每个中间节点记录以下内容：划分方向，划分位置，两个子节点  
		对每个叶子节点存储：实际的物体  
		在树从根节点开始向下查找相交格子，然后再找物体  
- 物体划分：  
	- Bounding Volume Hierarchy (BVH)  
		每次先把物体分堆，然后对每堆物体求包围盒，然后将盒子加入树  
		保证一个物体只出现在一个叶子节点  
	- SAH (Surface Area Heuristic) 优化  
		**目标**：在BVH构建中智能选择分割策略，最小化光线追踪预期计算代价    
		**核心原理**：光线击中包围盒的概率 ∝ 包围盒表面积  
		- 代价模型  

			$$  
				\begin{gathered}   
				C(N)=C_{trav}+SA(B_{left})SA(N)\times C_{left}+SA(B_{right})SA(N)\times C_{right}C(N) \\ =C_{trav}​+SA(N)SA(B_{left}​)\times C_{left}​+SA(N)SA(B_{right}​)​\times C_{right}  
				\end{gathered}   
				$$  
  
			- $C_{trav}$：节点遍历开销（常量，≈0.125~1.0）  
			- $SA(B)$：包围盒$B$的表面积  
			- $C_{left/right}$：子树代价（叶子节点：$C_{prim} \times |P|$）  
		- 桶式实现 (Binned SAH)  
			1. **分桶**：沿轴(X/Y/Z)均匀划分$K$个桶（$K=16,32,64$）  
			2. **候选分割**：仅考虑桶边界处  
			    - 动态维护左右桶集的包围盒  
			    - 计算每个分割点代价$C(N)$  
			3. **复杂度**：$O(Kn)$，远优于$O(n^2)$  
- 划分技巧：  
	每次对盒子最长的轴划分  
	对一堆物体划分，沿中位数物体划分（快速选择算法）  
  
  
## 辐射度量学  
  
Radiant Energy and Flux  
energy  -> J(Joule)    $Q$  
flux ->W(Watt)/lm(lumen)  $\Phi \equiv  \frac{dQ}{dt}$  
某个光源面积上的光强度   radiance  
光源某方向发出的光的强度   radiant intensity / intensity   
到达某一物体点上的光的强度（总和）   irradiance  
  
- intensity  
	power per unit solid angle  
	光源在特定方向的单位立体角发出的功率  

	$$I(\omega) \equiv  \frac{d\Phi}{d\omega}$$ $$[\frac{W}{sr}][\frac{lm}{sr}=cd=candela]$$   
	solid angle 立体角，单位sr  
	立体角：  
	$\Omega=\frac{A}{r^2}$     in a sphere,$\Omega \in [0,4\pi]$  

	$$d\Omega=\sin\theta d\theta  d\phi$$	$$\Phi=\int_{S^2}Id\omega=4\pi I$$ $$I=\frac{\Phi}{4\pi}$$  
- irradiance  
	power per projected unit area  
	单位投影面积接收的功率  

	$$E(\omega) \equiv  \frac{d\Phi}{dA\cos\theta}$$  
	面积取等效投影面积，即乘上了$cos\theta$  
- radiance  
	power per unit solid angle per projected unit area  
	->intensity per projected unit area  
	->irradiance per solid angle  

	$$L(p,\omega)\equiv \frac{d^2\Phi(p,\omega)}{d\omega dA\cos\theta}$$  
- radiance & irradiance   

	$$  
	\begin{gathered}  
	dE(p, \omega) = L_i(p, \omega) \cos \theta \, d\omega \\  
	E(p) = \int_{H^2} L_i(p, \omega) \cos \theta \, d\omega   
	\end{gathered}  
	$$  
  
## 辐射度量学 (Radiometry)  
- 基础物理量  
  
| 名称               | 符号  | 定义                                                                                | 单位             |  
| ---------------- | --- | --------------------------------------------------------------------------------- | -------------- |  
| 辐射能量 (Energy)    | Q   | -                                                                                 | J (焦耳)         |  
| 辐射通量 (Flux)      | Φ   | $\Phi \equiv \frac{\mathrm{d}Q}{\mathrm{d}t}$                                     | W (瓦特)/lm (流明) |  
| 辐射强度 (Intensity) | I   | $I(\omega) \equiv \frac{\mathrm{d}\Phi}{\mathrm{d}\omega}$                        | W/sr, cd (坎德拉) |  
| 辐照度 (Irradiance) | E   | $E \equiv \frac{\mathrm{d}\Phi}{\mathrm{d}A^\perp}$                               | W/m²           |  
| 辐射亮度 (Radiance)  | L   | $L(p,\omega) \equiv \dfrac{\mathrm{d}^2\Phi}{\mathrm{d}\omega \mathrm{d}A^\perp}$ | W/(sr·m²)      |  
- 关键概念详解  
	#### 1. 立体角 (Solid Angle)  
	- **定义**：$\Omega = \frac{A}{r^2}$  
	- **微分形式**：$\mathrm{d}\Omega = \sin\theta \mathrm{d}\theta \mathrm{d}\phi$  
	- **全空间范围**：$0$ 到 $4\pi$ sr  
	#### 2. 辐射强度 (Intensity)  
	- **物理意义**：光源在单位立体角发出的功率  
	- **与通量关系**：  

	  $$\Phi = \int_{4\pi} I(\omega) \mathrm{d}\omega \quad \text{(各向异性光源)}$$  

	  $$I = \frac{\Phi}{4\pi} \quad \text{(各向同性点光源)}$$  
	#### 3. 辐照度 (Irradiance)  
	- **核心要点**：使用**投影面积** $dA^\perp = dA \cos\theta$  
	- **物理意义**：表面单位面积接收的功率（与入射角相关）  
	#### 4. 辐射亮度 (Radiance)  
	- **三重解释**：  
	  1. 单位立体角 × 单位投影面积的功率  
	  2. 单位投影面积的辐射强度：$L = \dfrac{\mathrm{d}I}{\mathrm{d}A^\perp}$  
	  3. 单位立体角的辐照度：$L = \dfrac{\mathrm{d}E}{\mathrm{d}\omega \cos\theta}$  
	    这里除以$\cos\theta$是因为E计算时考虑了照射角度的影响，而L则是与角度无关，是光线本身的性质描述  
- 核心关系式  
	  
	- 辐射亮度 → 辐照度  

	$$  
	\begin{align}  
	\mathrm{d}E(p, \omega_i) &= L_i(p, \omega_i) \cos\theta_i  \mathrm{d}\omega_i \\  
	E(p) &= \int_{\mathcal{H}^2} L_i(p, \omega_i) \cos\theta_i  \mathrm{d}\omega_i   
	\end{align}  
	$$  
		- $\mathcal{H}^2$：半球空间（法线方向）  
		- $\cos\theta_i$：入射角余弦（Lambert 余弦定律）  
  
## 双向反射分布函数BRDF  
bidirectional reflectence distribution function  
- brdf函数  

	$$  
	\begin{gathered}  
	f(\omega_i \to \omega_r) = \frac{\mathrm{d}L_r(\omega_r)}{\mathrm{d}E_i(\omega_i)}   
	= \frac{\mathrm{d}L_r(\omega_r)}{L_i(\omega_i) \cos \theta_i  \mathrm{d}\omega_i}  \quad \left[\frac{1}{\mathrm{sr}}\right]  
	\end{gathered}  
	$$  
	函数f描述了在$\mathrm{d}A$大小的面S上，接收的光源$\mathrm{d}\omega_i$方向的irradiance($\mathrm{d}E_i(\omega_i)$)按什么比例分配给$\mathrm{d}\omega_r$方向的radiance($\mathrm{d}L_r(\omega_r)$)，此处$\theta_i$自然是入射光的角度  
	这里irradiance中，S作为接收方（物体）；radiance中，S作为发出方（光源）  
	反射方程：  

	$$  
	\begin{gathered}  
	L_r(\mathbf{p}, \omega_r) = \int_{\mathcal{H}^2} f_r(\mathbf{p}, \omega_i \to \omega_r) L_i(\mathbf{p}, \omega_i) \cos\theta_i  \mathrm{d}\omega_i  
	\end{gathered}  
	$$  
	这里对$H^2$积分是对上半球面（平面外侧）积分，如果是透明材料需要计算全球  
	每个入射方向都对应一条**完整光路**的终点  
- brdf性质  
	- 非负  
	- 线性  可以分块运算  
	- 可逆性  交换入射出射方向，brdf函数不变  
	- 能量守恒 系数比例小于等于1 反射方程右侧去掉入射光强度$L_i$得到的积分结果小于等于1  
- 渲染方程  

	$$  
	L_o(\mathbf{p}, \omega_o) = L_e(\mathbf{p}, \omega_o) + \int_{\mathcal{H}^2} f_r(\mathbf{p}, \omega_i, \omega_o) \, L_i(\mathbf{p}, \omega_i) \, (\mathbf{n} \cdot \omega_i)  \mathrm{d}\omega_i  
	$$  
	这个方程是从局部视角，考虑一条光线的来去  
	用u和v代表光源和物体两个位置，即
	
	$$  
	L(u) = E(u) + \int K(u,v) \, L(v) \, \mathrm{d}v 
	$$  
	更进一步，从全局视角，考虑场函数算子形式，即$$  
	L=E+KL  
	$$  
	  
  
- 渲染方程的算子形式  
	- 基本方程  

		$$  
		L = E + KL  
		$$  
		- **$L$**: 场景的辐射亮度场 (Radiance field)  
		- **$E$**: 自发光项 (Emission)  
		- **$K$**: 光传输算子 (Light transport operator)  
		**关于这里L相同的理解：渲染方程的积分形式里的$L_i$和$L_o$代表入射光强度与出射光强度，其比值由材质决定，不一定为1，而算子形式的渲染方程的L是定义在整个场景上的辐射亮度场函数  
		而能量被吸收的部分，实际上就是光线的衰弱“系数”，表现为级数的有限性，因此也在方程考虑范围内**  
	- 推导过程  

		$$  
		\begin{align}  
		IL - KL &= E  \quad \text{(引入单位算子)} \\  
		(I - K)L &= E  \quad \text{(算子因式分解)} \\  
		L &= (I - K)^{-1}E  \quad \text{(算子求逆)}  
		\end{align}  
		$$  
		  
	- Neumann 级数展开  
		利用二项式定理的算子形式（Neumann 级数）：  
  
		$$  
		\begin{aligned}  
		L &= (I - K)^{-1}E \\  
		&= (I + K + K^2 + K^3 + \cdots)E  \quad \text{(当 $\|K\|<1$ 时收敛)} \\  
		&= E + KE + K^2E + K^3E + \cdots  
		\end{aligned}  
		$$  
- brdf 的测量:  
	利用各向同性的特性，可以少测量一个维度  
  
  
  
  
  
## 概率密度函数  
一种分布函数  
  
  
  
## 蒙特卡洛积分  
  
| **Definite integral**     | $\int_{a}^{b} f(x)dx$                                                            |  
| :------------------------ | :------------------------------------------------------------------------------- |  
| **Random variable**       | $X_{i} \sim p(x)$                                                                |  
| **Monte Carlo estimator** | $F_{N}=\frac{1}{N}\sum_{i=1}^{N}\frac{f\left(X_{i}\right)}{p\left(X_{i}\right)}$ |  
p即概率分布函数（概率密度函数），pdf  
当pdf与被采样函数f相同时，效果最好  
注意，采样对象和积分对象要一致，一般都选x轴  
  
蒙特卡洛积分采样函数要除以pdf（权重）的解释：考虑f图像与x轴所围区域，分割若干等宽竖条后，高度越高（即权重pdf越高）则面积越大，蒙特卡洛方法采样该区域概率会更大，因此除以权重即可使各区域采样概率相同，此时求和得到正确的近似积分结果。  
  
pdf函数积分为1，令pdf函数为常函数，则可解得pdf函数为$\frac{1}{b-a}$  
这里$b-a$ 在更广泛意义上理解为积分区间、积分区域等等即可，例如从立体角对半球均匀采样，则pdf函数为$\frac{1}{2\pi}$  
  
| **Definite integral**           | $\int_{a}^{b} f(x) dx$                                      |  
| :------------------------------ | :---------------------------------------------------------- |  
| **Uniform random variable**     | $X_{i} \sim p(x) = \dfrac{1}{b-a}$                          |  
| **Basic Monte Carlo estimator** | $F_{N} = \dfrac{b-a}{N} \sum_{i=1}^{N} f\left(X_{i}\right)$ |  
f是被采样函数，$X_i$是采样点，左边系数相当于计算矩形高度，采样得到矩形高度，求和即可  
  
$F_N$即 f 的积分  
  
## 路径追踪 Path Tracing  
```  
shade(p, wo)  
	Randomly choose N directions wi with pdf  
	Lo = 0.0  
	  
	For each wi:  
	    Trace ray r(p, wi)  
	    If ray hits light:  
	        Lo += (1/N) * L_i * f_r * cosine / pdf(wi)  
	    Else if ray hits object at q:  
	        Lo += (1/N) * shade(q, -wi) * f_r * cosine  
	  
	Return Lo  
```  
蒙特卡洛追踪伪代码如上  
令N为1时，得到的就是路径追踪，此时不会出现光线追踪后指数爆炸问题  
- 加入俄罗斯轮盘赌RR  
	```  
	shade(p, wo)  
		Manually specify a probability P_RR  
		Randomly select ksi in a uniform dist. in [0, 1]  
		  
		If (ksi > P_RR)  
		    return 0.0  
		  
		Randomly choose ONE direction wi with pdf(w)  
		Trace ray r(p, wi)  
		  
		If ray hits light:  
		    Return L_i * f_r * cosine / pdf(wi) / P_RR  
		  
		Else if ray hits object at q:  
		    Return shade(q, -wi) * f_r * cosine / pdf(wi) / P_RR  
	```  
- ray generation  
	```  
	ray_generation(camPos, pixel)  
		Uniformly choose N sample positions within the pixel  
		pixel_radiance = 0.0  
		  
		For each sample in the pixel:  
			Shoot ray r(camPos, cam_to_sample)  
			If ray hits scene at p:  
				pixel_radiance += (1/N) * shade(p, sample_to_cam)  
		  
		Return pixel_radiance  
	```  
- 考虑从在物体表面球上采样转为在光源表面球上采样，以提高采样有效率  
	此时需要修改渲染方程，将原本的$\mathrm{d}\omega$用$\mathrm{d}A$表示，即  

	$$  
	d\omega = \frac{dA \cos \theta'}{\|x' - x\|^2}  
	$$  
	此处$\theta'$是光线与光源微分面$\mathrm{d}A$的法向量的夹角（各种角默认取锐角）  
	x和x‘代表物体和光源的位置  
	  
	原理是先将$\mathrm{d}A$面投影到与$\mathrm{d}\omega$方向垂直的方向，然后除以距离平方，即得到立体角的微分（即物体单位表面球上$\mathrm{d}\omega$对应的微分面）  
	  
	利用此式可以在渲染方程中进行换元，注意积分区域等等需要相应变化  
  
  
## 光场 Light Field  
在任意一个位置，朝任意一个方向的光  
- 全光函数  $P(\theta,\phi,\lambda,t,V_x,V_y,V_z)$   
	$\lambda$是波长，前两个是方向，后三个是位置  
光场是全光函数的一部分  
光场需要两个位置参数，两个方向参数。其中位置参数是通过将三维的包围盒展开成二维后，在二维平面上获取的位置，参考纹理贴图的方式；方向参数使用立体角方式  
  
求一个面的光场，可以通过取该面的一个平行面。在该面上取点(u,v)，在平行面上取点(s,t)。只要使uv和st遍历两个面，即可获取该面的光场  
  
  
## 光线传播  
有偏/无偏：所采用蒙特卡洛方法的期望是/不是等于真实值。样本无穷多时期望收敛至无偏称为一致  
- 无偏光线传播   
	BDPT MLT  
	- 双向路径追踪BDPT  
		从光源、物体出发分别路径追踪一半，然后在中间某点处交汇  
	- MLT  
		当pdf与被采样函数f相同时，效果最好  
		利用马尔可夫链，在采样一些样本后，生成下一个样本，使样本分布与f相同  
- 有偏光线传播  
	光子映射 VCM  
	- 光子映射  
		适合渲染specular-diffuse-specular路径的光线以及caustics  
		有偏方法  
	- VCM  
		光子映射+BDPT  
- 实时辐射度算法IR  
	VPL vertual point light  
	实时生成若干vpl，实现计算直接光照同时计算间接光照  